<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>webrtc 学习 (一) 搭建 AppRTC 服务 - DevYK 个人博客</title><meta description="前言最近折腾了几天 apprtc 服务器搭建，搭建的主要目的是为了学习 Android 、WEB 等各端基于 webrtc 音视频通信。 经过这几天的搭建得出了几点结论: 1、非 https 协议在 chrome 浏览器不支持打开音视频设备。 2、如果想要使各端都能通信，那么必须所有请求访问都使用 https 协议，证书可以在购买服务器平台上免费申请。  如果你正在找工作, 那么你需要一份 An"><meta property="og:type" content="blog"><meta property="og:title" content="webrtc 学习 (一) 搭建 AppRTC 服务"><meta property="og:url" content="http://yoursite.com/2020/06/04/webrtc-%E5%AD%A6%E4%B9%A0-%E4%B8%80-%E6%90%AD%E5%BB%BA-AppRTC-%E6%9C%8D%E5%8A%A1/"><meta property="og:site_name" content="DevYK 个人博客"><meta property="og:description" content="前言最近折腾了几天 apprtc 服务器搭建，搭建的主要目的是为了学习 Android 、WEB 等各端基于 webrtc 音视频通信。 经过这几天的搭建得出了几点结论: 1、非 https 协议在 chrome 浏览器不支持打开音视频设备。 2、如果想要使各端都能通信，那么必须所有请求访问都使用 https 协议，证书可以在购买服务器平台上免费申请。  如果你正在找工作, 那么你需要一份 An"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200410000914.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200409234611.gif"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200410000148.gif"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200408153056.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200406213309.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200406213428.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200315232530.jpg"><meta property="article:published_time" content="2020-06-04T11:23:00.000Z"><meta property="article:modified_time" content="2020-06-04T15:52:04.063Z"><meta property="article:author" content="DevYK"><meta property="article:tag" content="webrtc"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200410000914.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2020/06/04/webrtc-%E5%AD%A6%E4%B9%A0-%E4%B8%80-%E6%90%AD%E5%BB%BA-AppRTC-%E6%9C%8D%E5%8A%A1/"},"headline":"DevYK 个人博客","image":["https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200410000914.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200409234611.gif","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200410000148.gif","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200408153056.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200406213309.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200406213428.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200315232530.jpg"],"datePublished":"2020-06-04T11:23:00.000Z","dateModified":"2020-06-04T15:52:04.063Z","author":{"@type":"Person","name":"DevYK"},"description":"前言最近折腾了几天 apprtc 服务器搭建，搭建的主要目的是为了学习 Android 、WEB 等各端基于 webrtc 音视频通信。 经过这几天的搭建得出了几点结论: 1、非 https 协议在 chrome 浏览器不支持打开音视频设备。 2、如果想要使各端都能通信，那么必须所有请求访问都使用 https 协议，证书可以在购买服务器平台上免费申请。  如果你正在找工作, 那么你需要一份 An"}</script><link rel="canonical" href="http://yoursite.com/2020/06/04/webrtc-%E5%AD%A6%E4%B9%A0-%E4%B8%80-%E6%90%AD%E5%BB%BA-AppRTC-%E6%9C%8D%E5%8A%A1/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="DevYK 个人博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">about</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-06-04T11:23:00.000Z" title="2020-06-04T11:23:00.000Z">2020-06-04</time><span class="level-item"> DevYK </span><span class="level-item"><a class="link-muted" href="/categories/%E6%9C%8D%E5%8A%A1/">服务</a><span> / </span><a class="link-muted" href="/categories/%E6%9C%8D%E5%8A%A1/apprtc/">apprtc</a></span><span class="level-item">18 分钟 读完 (大约 2629 个字)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">webrtc 学习 (一) 搭建 AppRTC 服务</h1><div class="content"><p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200410000914.png" alt=""></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近折腾了几天 <code>apprtc</code> 服务器搭建，搭建的主要目的是为了学习 Android 、WEB 等各端基于 webrtc 音视频通信。</p>
<p>经过这几天的搭建得出了几点结论:</p>
<p>1、非 <code>https</code> 协议在 <code>chrome</code> 浏览器不支持打开音视频设备。</p>
<p>2、如果想要使各端都能通信，那么必须所有请求访问都使用 <code>https</code> 协议，证书可以在购买服务器平台上免费申请。</p>
<blockquote>
<p>如果你正在找工作, 那么你需要一份 <a href="https://github.com/yangkun19921001/Blog/blob/master/笔试面试/Android高级工程师面试必备/README.md">Android 高级开发面试宝典</a></p>
</blockquote>
<a id="more"></a>

<p>以下是最终效果图(手机跟 <code>WEB</code> 互通需要所有 <code>http</code> 更换为 <code>https</code> 协议，该篇最终结果还未达到各端互通的条件，后续会更新补上)</p>
<p><strong>搭建环境</strong></p>
<ul>
<li>服务器: 腾讯云</li>
<li>系统: centos</li>
</ul>
<p><strong>app2app</strong></p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200409234611.gif" alt=""></p>
<p><strong>web2web</strong></p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200410000148.gif" alt=""></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>搭建 apprtc 需要用到以下几个服务。</p>
<h3 id="apprtc"><a href="#apprtc" class="headerlink" title="apprtc"></a>apprtc</h3><p>AppRTC 是用来创建和管理通话状态的房间服务器。</p>
<h3 id="coturn"><a href="#coturn" class="headerlink" title="coturn"></a>coturn</h3><p>coturn 是一种 <code>TURN</code> 内网穿透服务器（也就是中转服务器），该服务器用于 <code>VOIP</code> 或通用数据流的 <code>NAT</code> 穿越和数据转发。</p>
<h3 id="collider"><a href="#collider" class="headerlink" title="collider"></a>collider</h3><p>collider 它是用 go 语言实现的基于 WebSocket 的信令服务器。</p>
<p>为了建立一个 webrtc 的通信过程，一般是需要有如下通信信息:</p>
<p>1、会话控制信息，用来开始和结束通话，即开始视频、结束视频这些操作指令。</p>
<p>2、发生错误时用来相互通告的消息</p>
<p>3、元数据，如各自的音视频解码方式、带宽。</p>
<p>4、网络数据，对方的公网 IP、端口、内网 IP 及端口。</p>
<h2 id="搭建-AppRTC-服务的基本步骤"><a href="#搭建-AppRTC-服务的基本步骤" class="headerlink" title="搭建 AppRTC 服务的基本步骤"></a>搭建 AppRTC 服务的基本步骤</h2><p>1、搭建 AppRTC 房间服务器</p>
<p>2、搭建 Coturn 穿透服务器</p>
<p>3、搭建 Collider 信令服务器</p>
<p>4、搭建 ICE 信息服务器</p>
<h2 id="如何搭建-AppRTC"><a href="#如何搭建-AppRTC" class="headerlink" title="如何搭建 AppRTC"></a>如何搭建 AppRTC</h2><h3 id="1、install-JDK"><a href="#1、install-JDK" class="headerlink" title="1、install JDK"></a>1、install JDK</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看 Java 版本</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<h3 id="2、install-node-js"><a href="#2、install-node-js" class="headerlink" title="2、install node.js"></a>2、install node.js</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https://rpm.nodesource.com/setup_10.x | bash -</span><br><span class="line">yum install -y nodejs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 确认是否成功</span></span><br><span class="line">node --version</span><br><span class="line">npm --version</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 构建 apprtc 用到</span></span><br><span class="line">npm -g install grunt-cli</span><br><span class="line">grunt --version</span><br></pre></td></tr></table></figure>

<h3 id="3、安装Python和Python-webtest-（python2-7）"><a href="#3、安装Python和Python-webtest-（python2-7）" class="headerlink" title="3、安装Python和Python-webtest （python2.7）"></a>3、安装Python和Python-webtest （python2.7）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum install python python-webtest python-pip</span><br><span class="line">pip install --upgrade pip</span><br></pre></td></tr></table></figure>

<h3 id="4、安装google-appengine"><a href="#4、安装google-appengine" class="headerlink" title="4、安装google_appengine"></a>4、安装google_appengine</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/appengine-sdks/featured/google_appengine_1.9.40.zip</span><br><span class="line">unzip google_appengine_1.9.40.zip</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置环境变量：在/etc/profile文件最后增加一行：</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash">添加如下代码</span></span><br><span class="line">export google_appengine_path=/root/webrtc/google_appengine</span><br><span class="line">export PATH=$PATH:$google_appengine_path</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">最后保存，使之生效</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="5、安装-go"><a href="#5、安装-go" class="headerlink" title="5、安装 go"></a>5、安装 go</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install golang</span><br><span class="line"><span class="meta">#</span><span class="bash">查看是否安装成功</span></span><br><span class="line">go version </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建go工作目录</span></span><br><span class="line">mkdir -p /root/webrtc/goWorkspace/src</span><br><span class="line"><span class="meta">#</span><span class="bash">配置环境变量：在 vim /etc/profile 文件最后增加一行：</span></span><br><span class="line">export GOPATH=/root/webrtc/goWorkspace</span><br><span class="line"><span class="meta">#</span><span class="bash">保存</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="6、安装libevent"><a href="#6、安装libevent" class="headerlink" title="6、安装libevent"></a>6、安装libevent</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">当前目录:root/webrtc/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">https://github.com/coturn/coturn/wiki/CoturnConfig</span></span><br><span class="line">wget https://github.com/downloads/libevent/libevent/libevent-2.0.21-stable.tar.gz</span><br><span class="line">tar xvf libevent-2.0.21-stable.tar.gz</span><br><span class="line">cd libevent-2.0.21-stable</span><br><span class="line">./configure</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="7、安装-AppRTC"><a href="#7、安装-AppRTC" class="headerlink" title="7、安装 AppRTC"></a>7、安装 AppRTC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">当前目录:root/webrtc/</span></span><br><span class="line">git clone https://github.com/webrtc/apprtc.git</span><br><span class="line"><span class="meta">#</span><span class="bash">将collider的源码软连接到go的工作目录下</span></span><br><span class="line">ln -s /root/webrtc/apprtc/src/collider/collider $GOPATH/src</span><br><span class="line">ln -s /root/webrtc/apprtc/src/collider/collidermain $GOPATH/src</span><br><span class="line">ln -s /root/webrtc/apprtc/src/collider/collidertest $GOPATH/src</span><br><span class="line"><span class="meta">#</span><span class="bash">编译collidermain</span></span><br><span class="line">go get collidermain</span><br><span class="line">go install collidermain</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">go get collidermain: 被墙</span></span><br><span class="line"><span class="meta">#</span><span class="bash">报错: package golang.org/x/net/websocket: unrecognized import path <span class="string">"golang.org/x/net/websocket"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">执行: </span></span><br><span class="line"><span class="meta">#</span><span class="bash">mkdir -p <span class="variable">$GOPATH</span>/src/golang.org/x/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/golang.org/x/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">git <span class="built_in">clone</span> https://github.com/golang/net.git net </span></span><br><span class="line"><span class="meta">#</span><span class="bash">go install net</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">再执行编译collidermain</span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改房间服务器为我们前面的房间服务器:</span></span><br><span class="line">vim $GOPATH/src/collidermain/main.go</span><br><span class="line">var roomSrv = flag.String(“room-server”, “https://49.235.159.44:8080”, “The origin of the room server”)</span><br><span class="line"></span><br><span class="line">vim $GOPATH/src/collider/collider.go</span><br><span class="line"><span class="meta">#</span><span class="bash">修改放入自己私有证书,目前这里放入腾讯云申请的 证书测试 app -&gt; pc 通不了，固还是用自签名</span></span><br><span class="line">e = server.ListenAndServeTLS(“/root/key/chat.codecocoa.com.pem”, 		“/root/key/chat.codecocoa.com.key”)</span><br><span class="line"></span><br><span class="line">go get collidermain</span><br><span class="line">go install collidermain</span><br></pre></td></tr></table></figure>

<h3 id="8、安装coturn"><a href="#8、安装coturn" class="headerlink" title="8、安装coturn"></a>8、安装coturn</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">目录:root/webrtc/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">https://github.com/coturn/coturn/wiki/Downloads</span></span><br><span class="line">wget http://coturn.net/turnserver/v4.5.0.7/turnserver-4.5.0.7.tar.gz</span><br><span class="line">tar xvfz turnserver-4.5.0.7.tar.gz</span><br><span class="line">cd turnserver-4.5.0.7</span><br><span class="line"><span class="meta">#</span><span class="bash">如果没有 openssl-devel 需要安装</span></span><br><span class="line">yum install openssl-devel</span><br><span class="line">./configure --prefix=./bin</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="9、配置并运行-coturn-Nat-穿透服务器"><a href="#9、配置并运行-coturn-Nat-穿透服务器" class="headerlink" title="9、配置并运行 coturn Nat 穿透服务器"></a>9、配置并运行 coturn Nat 穿透服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">内网：172.17.0.11 ：DevYk:用户 12345 密码 &amp; ctr+c 不会停止</span></span><br><span class="line">nohup turnserver -L 172.17.0.11 -a -u DevYK:12345 -v -f -r nort.gov &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash">或者 作者用的该方案</span></span><br><span class="line">nohup turnserver -L 172.17.0.11 -a -u DevYK:12345 -v -f -r www.devyk.cn &amp; </span><br><span class="line"><span class="meta">#</span><span class="bash">netstat -ntulp 查看 5766，3478 端口是否启动</span></span><br></pre></td></tr></table></figure>

<h3 id="10、collider-信令服务器"><a href="#10、collider-信令服务器" class="headerlink" title="10、collider 信令服务器"></a>10、collider 信令服务器</h3><p>配置防火墙，允许访问8089端口（tcp，用于客户端和collider建立websocket信令通信）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建自签名的数字证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果没有openssl,需要安装</span></span><br><span class="line">mkdir -p /cert</span><br><span class="line">cd /cert</span><br><span class="line"><span class="meta">#</span><span class="bash"> CA私钥</span></span><br><span class="line">openssl genrsa -out key.pem 2048 </span><br><span class="line"><span class="meta">#</span><span class="bash"> 自签名证书</span></span><br><span class="line">openssl req -new -x509 -key key.pem -out cert.pem -days 1095</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">app 与 app 通信由于 ssl 问题需要将 tls =<span class="literal">false</span></span></span><br><span class="line">nohup $GOPATH/bin/collidermain -port=8089 -tls=true -room-server="https://49.235.159.44:8080" &gt; /root/webrtc/collidermain.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">检查 8089 端口是否启动</span></span><br><span class="line">netstat -ntulp</span><br></pre></td></tr></table></figure>

<h3 id="11-apprtc-房间服务器"><a href="#11-apprtc-房间服务器" class="headerlink" title="11. apprtc 房间服务器"></a>11. apprtc 房间服务器</h3><p>配置防火墙，允许访问8080端口（tcp，此端口用于web访问）</p>
<p>配置文件修改（主要是配置apprtc对应的conturn和collider相关参数）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">49.235.159.44 外网ip</span></span><br><span class="line">vim /root/webrtc/apprtc/src/app_engine/constants.py</span><br></pre></td></tr></table></figure>

<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200408153056.png" alt=""></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ICE_SERVER_OVERRIDE = None</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Enable by uncomment below and comment out above, <span class="keyword">then</span> specify turn and stun</span></span><br><span class="line">ICE_SERVER_OVERRIDE  = [</span><br><span class="line">   &#123;</span><br><span class="line">     "urls": [</span><br><span class="line">       "turn:49.235.159.44:3478?transport=udp",</span><br><span class="line">       "turn:49.235.159.44:3478?transport=tcp"</span><br><span class="line">     ],</span><br><span class="line">     "username": "DevYK",</span><br><span class="line">     "credential": "12345"</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">     "urls": [</span><br><span class="line">       "stun:49.235.159.44:8089"</span><br><span class="line">     ]</span><br><span class="line">   &#125;</span><br><span class="line"> ]</span><br><span class="line"><span class="meta">#</span><span class="bash">ICE_SERVER_OVERRIDE = None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">pc 必须使用 https</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ICE_SERVER_BASE_URL = <span class="string">'https://49.235.159.44'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">在 APP 上因为没有 SSL 证书，那么只能用 http</span></span><br><span class="line">ICE_SERVER_BASE_URL = 'http://49.235.159.44:8088'</span><br><span class="line">ICE_SERVER_URL_TEMPLATE = '%s/v1alpha/iceconfig?key=%s'</span><br><span class="line">ICE_SERVER_API_KEY = os.environ.get('ICE_SERVER_API_KEY')</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Dictionary keys <span class="keyword">in</span> the collider instance info constant.</span></span><br><span class="line">WSS_INSTANCE_HOST_KEY = '49.235.159.44:8089'</span><br><span class="line">WSS_INSTANCE_NAME_KEY = 'vm_name'</span><br><span class="line">WSS_INSTANCE_ZONE_KEY = 'zone'</span><br><span class="line">WSS_INSTANCES = [&#123;</span><br><span class="line">    WSS_INSTANCE_HOST_KEY: '49.235.159.44:8089',</span><br><span class="line">    WSS_INSTANCE_NAME_KEY: 'wsserver-std',</span><br><span class="line">    WSS_INSTANCE_ZONE_KEY: 'us-central1-a'</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">,&#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    WSS_INSTANCE_HOST_KEY: <span class="string">'49.235.159.44:8089'</span>,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    WSS_INSTANCE_NAME_KEY: <span class="string">'wsserver-std-2'</span>,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    WSS_INSTANCE_ZONE_KEY: <span class="string">'us-central1-f'</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">&#125;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">编译</span></span><br><span class="line">cd /root/webrtc/apprtc</span><br><span class="line">npm install</span><br><span class="line">grunt build</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">如果出现下面错误,使用 cnpm 编译</span></span><br><span class="line">/root/webrtc/apprtc/node_modules/mkdirp/lib/opts-arg.js </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">npm 安装出现问题 使用 cnpm 安装</span></span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line">cnpm install</span><br><span class="line">grunt build</span><br></pre></td></tr></table></figure>

<p>启动:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">172.31.247.136 : 内网ip</span></span><br><span class="line">nohup dev_appserver.py --host=172.17.0.11 --port 8080 /root/webrtc/apprtc/out/app_engine --skip_sdk_update_check &gt; /root/webrtc/apprtc.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">检查 8080 Python 是否起来</span></span><br><span class="line">netstat -ntulp</span><br></pre></td></tr></table></figure>

<h3 id="12、-配置-ICE-Service"><a href="#12、-配置-ICE-Service" class="headerlink" title="12、 配置 ICE Service"></a>12、 配置 ICE Service</h3><p>mkdir /root/webrtc/iceService</p>
<p>vim ice.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>)</span><br><span class="line"><span class="keyword">var</span> hmac = <span class="function"><span class="keyword">function</span>(<span class="params">key, content</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> method = crypto.createHmac(<span class="string">'sha1'</span>, key)</span><br><span class="line">  method.setEncoding(<span class="string">'base64'</span>)</span><br><span class="line">  method.write(content)</span><br><span class="line">  method.end()</span><br><span class="line">  <span class="keyword">return</span> method.read()</span><br><span class="line">&#125;</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//账户</span></span><br><span class="line">  <span class="keyword">var</span> timestamp = <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">var</span> turn_username = timestamp + <span class="string">':DevYK'</span></span><br><span class="line">  <span class="comment">//密码</span></span><br><span class="line">  <span class="keyword">var</span> key = <span class="string">'12345'</span></span><br><span class="line">  <span class="keyword">var</span> password = hmac(key, turn_username)</span><br><span class="line">  <span class="comment">// 发送 HTTP 头部 </span></span><br><span class="line">  <span class="comment">// HTTP 状态值: 200 : OK</span></span><br><span class="line">  <span class="comment">// 内容类型: text/plain</span></span><br><span class="line">  response.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(turn_username);</span><br><span class="line">  <span class="built_in">console</span>.log(password);</span><br><span class="line">  <span class="comment">// 发送响应数据 "ice服务器"</span></span><br><span class="line">  response.end(<span class="string">'&#123;"iceServers":[&#123;"username":"'</span>+turn_username+<span class="string">'","credential":"'</span>+password+<span class="string">'","urls":["stun:49.235.159.44:3478","turn:49.235.159.44:3478"]&#125;]&#125;\n'</span>);</span><br><span class="line">  &#125;).listen(<span class="number">8088</span>);</span><br><span class="line">  <span class="comment">// 终端打印如下信息</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'ICE Server running'</span>);</span><br></pre></td></tr></table></figure>

<p><strong>启动 ICE REST API 服务</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nohup node ice.js &amp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">检查 8088 服务是否启动</span></span><br><span class="line">netstat -ntulp</span><br></pre></td></tr></table></figure>



<h3 id="13、nginx-设置反向代理"><a href="#13、nginx-设置反向代理" class="headerlink" title="13、nginx 设置反向代理"></a>13、nginx 设置反向代理</h3><h4 id="nginx-已存在进行配置"><a href="#nginx-已存在进行配置" class="headerlink" title="nginx 已存在进行配置"></a>nginx 已存在进行配置</h4><p>11.1 配置反向代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">        worker_connections 1024;</span><br><span class="line">		&#125;</span><br><span class="line">		http&#123;</span><br><span class="line"><span class="meta">			#</span><span class="bash">apprtc 服务</span></span><br><span class="line">        upstream roomserver &#123;</span><br><span class="line">        server 49.235.159.44:8080;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">                listen 80;</span><br><span class="line">                server_name 49.235.159.44;</span><br><span class="line">                return  301 https://$server_name$request_uri;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">                root /root/webrtc/nginx-1.17.8/html;</span><br><span class="line">                index index.php index.html index.htm;</span><br><span class="line">                listen      443 ssl;</span><br><span class="line">                #腾讯云证书</span><br><span class="line">                #ssl_certificate /root/ssl/1_www.devyk.cn_bundle.crt;</span><br><span class="line">                #ssl_certificate_key /root/ssl/2_www.devyk.cn.key;</span><br><span class="line">                #ssl_session_timeout 5m;</span><br><span class="line">                 #请按照以下协议配置</span><br><span class="line">                #ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">                #请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span><br><span class="line">                #ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">                #ssl_prefer_server_ciphers on;</span><br><span class="line">                #自签名</span><br><span class="line">                ssl_certificate /cert/cert.pem;</span><br><span class="line">                ssl_certificate_key /cert/key.pem;</span><br><span class="line">                server_name 49.235.159.44;</span><br><span class="line">                location / &#123;</span><br><span class="line">                        proxy_pass http://roomserver$request_uri;</span><br><span class="line">                        proxy_set_header Host $host;</span><br><span class="line">                &#125;</span><br><span class="line">                location ~ .php$ &#123;</span><br><span class="line">                        fastcgi_pass unix:/var/run/php5-fpm.sock;</span><br><span class="line">                        fastcgi_index index.php;</span><br><span class="line">                        include fastcgi_params;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>11.1.1已安装但是没有配置 ssl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">开启 nginx 服务 error</span></span><br><span class="line">nginx: [emerg] the "ssl" parameter requires ngx_http_ssl_module in </span><br><span class="line">/bin/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>解决:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">切换到源码包：</span></span><br><span class="line">cd /nginx/nginx-1.17.9</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看nginx原有的模块</span></span><br><span class="line">/bin/sbin/nginx -V</span><br><span class="line"><span class="meta">#</span><span class="bash">在configure arguments:后面显示的原有的configure参数如下：</span></span><br><span class="line">--prefix=./bin</span><br></pre></td></tr></table></figure>

<p>重新编译, 加入 <code>--with-http_ssl_module</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=./bin  --with-http_ssl_module</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">编译</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>ps: 这里千万别 make install 覆盖安装，因为之前还有 nginx 配置。</p>
<p>将之前的 nginx rm 替换为 objs/nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在 nginx/1.17 模块下</span></span><br><span class="line"></span><br><span class="line">rm -rf bin/sbin/nginx</span><br><span class="line"></span><br><span class="line">cp objs/nginx bin/sbin/</span><br></pre></td></tr></table></figure>

<p>最后重启服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line">bin/sbin/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">重启</span></span><br><span class="line">bin/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>



<h4 id="nginx-未安装配置"><a href="#nginx-未安装配置" class="headerlink" title="nginx 未安装配置"></a>nginx 未安装配置</h4><p>11.2 下载 nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.17.9.tar.gz</span><br><span class="line">tar -zxvf nginx-1.17.9.tar.gz</span><br></pre></td></tr></table></figure>

<p>11.2.1编译 nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=./bin --with-http_ssl_module</span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>11.2.2 配置 nginx.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /root/webrtc/nginx-1.17.8/bin/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">apprtc 服务</span></span><br><span class="line">		events &#123;</span><br><span class="line"> 			worker_connections 1024;</span><br><span class="line">		&#125;</span><br><span class="line">		http&#123;</span><br><span class="line">        upstream roomserver &#123;</span><br><span class="line">        server 49.235.159.44:8080;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">                listen 80;</span><br><span class="line">                server_name www.devyk.cn;</span><br><span class="line">                return  301 https://$server_name$request_uri;</span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">                root /root/nginx/nginx-1.17.8/html;</span><br><span class="line">                index index.php index.html index.htm;</span><br><span class="line">                listen      443 ssl;</span><br><span class="line">                #腾讯云证书</span><br><span class="line">                #ssl_certificate /root/nginx/nginx-1.17.8-http-rtmp/ssl/rtc.crt;</span><br><span class="line">                #ssl_certificate_key /root/nginx/nginx-1.17.8-http-rtmp/ssl/rtc.key;</span><br><span class="line">                #自签名证书</span><br><span class="line">                ssl_certificate /cert/cert.pem;</span><br><span class="line">                ssl_certificate_key /cert/key.pem;</span><br><span class="line">                server_name 49.235.159.44;</span><br><span class="line">                location / &#123;</span><br><span class="line">                        proxy_pass http://roomserver$request_uri;</span><br><span class="line">                        proxy_set_header Host $host;</span><br><span class="line">                &#125;</span><br><span class="line">                location ~ .php$ &#123;</span><br><span class="line">                        fastcgi_pass unix:/var/run/php5-fpm.sock;</span><br><span class="line">                        fastcgi_index index.php;</span><br><span class="line">                        include fastcgi_params;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>11.2.3 启动 nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line">bin/sbin/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">重启</span></span><br><span class="line">bin/sbin/nginx -s reload</span><br></pre></td></tr></table></figure>



<h3 id="搭建中遇见的问题"><a href="#搭建中遇见的问题" class="headerlink" title="搭建中遇见的问题"></a>搭建中遇见的问题</h3><ul>
<li><p>浏览器通话跨域问题 :pushState</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /root/webrtc/apprtc/out/app_engine/js/apprtc.debug.js</span><br><span class="line"><span class="meta">#</span><span class="bash">全局搜索  pushState 增加:</span></span><br><span class="line">roomLink=roomLink.substring("http","https");</span><br></pre></td></tr></table></figure>

<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200406213309.png" alt=""></p>
</li>
<li><p>Websocket open error：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Messages:  </span><br><span class="line">WebSocket open error: WebSocket error.</span><br><span class="line">WebSocket register error: WebSocket error.</span><br></pre></td></tr></table></figure>

<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200406213428.png" alt=""></p>
<p> PC 上如果遇见这个问题，一般需要检查 apprtc 、 constants.py 、签名的配置信息。</p>
</li>
<li><p>自签名证书只能在浏览器上使用，不能用于浏览器与 Android 等端进行通信。</p>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整个服务搭建下来，坑确实太多了。目前由于没有证书，所以只能用于 app2app 、web2web 测试了，等证书申请下来在来更新替换过程。</p>
<p>以上搭建只要按照文中步骤肯定是可以成功的，希望可以帮助到你。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/91289458">https://zhuanlan.zhihu.com/p/91289458</a></li>
<li><a href="https://www.jianshu.com/p/a19441034f17">AppRTC(WebRTC)服务器搭建</a></li>
</ul>
<h2 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h2><ul>
<li>Email: <a href="mailto:yang1001yk@gmail.com">yang1001yk@gmail.com</a></li>
<li>个人博客: <a href="https://www.devyk.top">https://www.devyk.top</a></li>
<li>GitHub: <a href="https://github.com/yangkun19921001">https://github.com/yangkun19921001</a></li>
<li>掘金博客: <a href="https://juejin.im/user/578259398ac2470061f3a3fb">https://juejin.im/user/578259398ac2470061f3a3fb/posts</a></li>
</ul>
<p><strong>扫码关注我的公众号，让我们离得更进一些!</strong></p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200315232530.jpg" alt=""></p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/webrtc/">webrtc</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200604150710.jpeg" alt="支付宝"></span></a><a class="button donate" href="/" style="background-color:rgba(255,128,62,.87);border-color:transparent;color:white;" target="_blank" rel="noopener"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button is-danger donate" href="/" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200604150835.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E4%B8%80-%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">性能优化 (一) 启动优化</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/06/04/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0-%E5%8D%81%E4%BA%8C-FFmpeg-OpenSL-ES-%E5%AE%9E%E7%8E%B0%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/"><span class="level-item">音视频学习 (十二) FFmpeg + OpenSL ES 实现音频播放器</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "j16d0HiTJvVWRQzjQN625f4W-gzGzoHsz",
            appKey: "7cgla0UfvddS9PjRz7Lcvqn7",
            placeholder: "请遵守中华人民共和国法律法规。填写邮箱信息以接收回复。",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200427113132.jpeg" alt="DevYK"></figure><p class="title is-size-4 is-block line-height-inherit">DevYK</p><p class="is-size-6 is-block">Android/NDK/音视频/跨平台</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">27</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">3</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/yangkun19921001" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/yangkun19921001"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="QQ" href="http://wpa.qq.com/msgrd?v=1&amp;uin=919079498&amp;site=ioshenmue&amp;menu=yes"><i class="fab fa-qq"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://github.com/yangkun19921001/Blog/blob/master/about.md" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">联系我</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://juejin.im/user/578259398ac2470061f3a3fb/posts" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.im</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/%E4%B8%93%E9%A2%98/"><span class="level-start"><span class="level-item">专题</span></span><span class="level-end"><span class="level-item tag">25</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><span class="level-start"><span class="level-item">性能优化</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E4%B8%93%E9%A2%98/%E9%9F%B3%E8%A7%86%E9%A2%91/"><span class="level-start"><span class="level-item">音视频</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%9C%8D%E5%8A%A1/"><span class="level-start"><span class="level-item">服务</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/%E6%9C%8D%E5%8A%A1/apprtc/"><span class="level-start"><span class="level-item">apprtc</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%9C%8D%E5%8A%A1/nginx/"><span class="level-start"><span class="level-item">nginx</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/webrtc/"><span class="tag">webrtc</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><span class="tag">性能优化</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/"><span class="tag">音视频学习路线</span><span class="tag is-grey-lightest">12</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:33:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E5%BF%85%E7%9C%8B%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/">必看的性能优化总结</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:31:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81%E4%B8%89-%E7%A8%B3%E5%AE%9A%E8%BF%90%E8%A1%8C%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8D%95%E8%8E%B7-Native-Crash/">性能优化 (十三) 稳定运行优化之捕获 Native Crash </a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:30:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81%E4%BA%8C-%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96%E4%B9%8B%E6%9E%81%E9%99%90%E7%98%A6%E8%BA%AB/">性能优化 (十二) 体积优化之极限瘦身</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:29:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81%E4%B8%80-%E7%A8%B3%E5%AE%9A%E8%BF%90%E8%A1%8C%E4%BC%98%E5%8C%96%E4%B9%8B%E7%83%AD%E4%BF%AE%E5%A4%8D%E5%8E%9F%E7%90%86%E6%8E%A2%E7%B4%A2/">性能优化 (十一) 稳定运行优化之热修复原理探索</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:27:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81-%E6%8C%81%E7%BB%AD%E8%BF%90%E8%A1%8C%E4%BC%98%E5%8C%96%E4%B9%8B%E8%BF%9B%E7%A8%8B%E4%BF%9D%E6%B4%BB%E5%AE%9E%E7%8E%B0/">性能优化 (十) 稳定运行优化之进程保活实现 </a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="DevYK 个人博客" height="28"></a><p class="size-small"><span>&copy; 2020 DevYK</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://yoursite.com',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>