<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>音视频学习 (三) JNI 从入门到掌握 - DevYK 个人博客</title><meta description="前言音视频系列文章已经发布 2 篇了，C&amp;#x2F;C++ 基础咱们也已经学完了，那么该篇文章开始就真正进入 NDK 学习了，在进入 NDK 学习之前我们还要学习 JNI 基础。为了保证该系列文章输出，以后尽量一周一篇。"><meta property="og:type" content="blog"><meta property="og:title" content="音视频学习 (三) JNI 从入门到掌握"><meta property="og:url" content="http://yoursite.com/2020/06/04/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0-%E4%B8%89-JNI-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%8E%8C%E6%8F%A1/"><meta property="og:site_name" content="DevYK 个人博客"><meta property="og:description" content="前言音视频系列文章已经发布 2 篇了，C&amp;#x2F;C++ 基础咱们也已经学完了，那么该篇文章开始就真正进入 NDK 学习了，在进入 NDK 学习之前我们还要学习 JNI 基础。为了保证该系列文章输出，以后尽量一周一篇。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200109003933.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200107194733.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200107202203.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108204504.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108154952.gif"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108222721.png"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108231036.gif"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108232508.gif"><meta property="og:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200109003303.gif"><meta property="article:published_time" content="2020-06-04T09:44:00.000Z"><meta property="article:modified_time" content="2020-06-04T15:55:47.159Z"><meta property="article:author" content="DevYK"><meta property="article:tag" content="音视频学习路线"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200109003933.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2020/06/04/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0-%E4%B8%89-JNI-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%8E%8C%E6%8F%A1/"},"headline":"DevYK 个人博客","image":["https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200109003933.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200107194733.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200107202203.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108204504.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108154952.gif","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108222721.png","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108231036.gif","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108232508.gif","https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200109003303.gif"],"datePublished":"2020-06-04T09:44:00.000Z","dateModified":"2020-06-04T15:55:47.159Z","author":{"@type":"Person","name":"DevYK"},"description":"前言音视频系列文章已经发布 2 篇了，C&#x2F;C++ 基础咱们也已经学完了，那么该篇文章开始就真正进入 NDK 学习了，在进入 NDK 学习之前我们还要学习 JNI 基础。为了保证该系列文章输出，以后尽量一周一篇。"}</script><link rel="canonical" href="http://yoursite.com/2020/06/04/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0-%E4%B8%89-JNI-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%8E%8C%E6%8F%A1/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="DevYK 个人博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-06-04T09:44:00.000Z" title="2020-06-04T09:44:00.000Z">2020-06-04</time><span class="level-item"> DevYK </span><span class="level-item"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a><span> / </span><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a></span><span class="level-item">42 分钟 读完 (大约 6280 个字)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">音视频学习 (三) JNI 从入门到掌握</h1><div class="content"><p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200109003933.png" alt=""></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>音视频系列文章已经发布 2 篇了，C/C++ 基础咱们也已经学完了，那么该篇文章开始就真正进入 NDK 学习了，在进入 NDK 学习之前我们还要学习 JNI 基础。为了保证该系列文章输出，以后尽量一周一篇。</p>
<a id="more"></a>


<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>JNI 是 Java 程序设计语言功能功能最强的特征，它允许 Java 类的某些方法原生实现，同时让它们能够像普通 Java 方法一样被调用和使用。这些原生方法也可以使用 Java 对象，使用方法与 Java 代码调用 Java 对象的方法相同。原生方法可以创建新的 Java 对象或者使用 Java 应用程序创建的对象，这些 Java 应用程序可以检查、修改和调用这些对象的方法以执行任务。</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>安装 AS + NDK + CMake + LLDB</p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200107194733.png" alt=""></p>
<ul>
<li>AS: Android 开发工具。</li>
<li>NDK：这套工具集允许为 Android 使用 C 和 C++ 代码。</li>
<li>CMake：一款外部构建工具，可与 Gradle 搭配使用来构建原生库。如果只计划使用 ndk-build，则不需要此组件。</li>
<li>LLDB：debug 调式。</li>
</ul>
<p><strong>local.properties 配置:</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">ndk.dir</span>=<span class="string">/Users/devyk/Data/Android/SDK/ndk-bundle</span></span><br><span class="line"><span class="meta">sdk.dir</span>=<span class="string">/Users/devyk/Data/Android/SDK</span></span><br></pre></td></tr></table></figure>

<p><strong>build.gradle 配置:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">...</span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            path <span class="string">"src/main/cpp/CMakeLists.txt"</span></span><br><span class="line">            version <span class="string">"3.10.2"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><ol>
<li><p>创建 native c++ 工程</p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200107202203.png" alt=""></p>
<p>根据提示点击 next</p>
</li>
<li><p>基本代码生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 加载 native 库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        TextView tv = findViewById(R.id.sample_text);</span><br><span class="line">        <span class="comment">/**3.调用 native c++ 函数*/</span></span><br><span class="line">        tv.setText(stringFromJNI());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2. 定义 native 函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Native-lib.cpp 代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_devyk_ndk_1sample_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv* env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++"</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行之后屏幕就会出现  “Hello from C++” 字符串，一个最简单的 native 项目就创建完成了。</p>
</li>
</ol>
<h2 id="JNI-入门学习"><a href="#JNI-入门学习" class="headerlink" title="JNI 入门学习"></a>JNI 入门学习</h2><h3 id="1-数据类型和类型描述符"><a href="#1-数据类型和类型描述符" class="headerlink" title="1. 数据类型和类型描述符"></a>1. 数据类型和类型描述符</h3><p>Java 中有两种数据类型:</p>
<ul>
<li>基本数据类型: boolean 、char、byte、int、short、long、float、double。</li>
<li>引用数据类型: String、Object[]、Class、Object 及其它类。</li>
</ul>
<p><strong>1.1 基本数据类型</strong></p>
<p>基本数据类型可以直接与 C/C++ 的相应基本数据类型映射，如下表所示。JNI 用类型定义使得这种映射对开发人员透明。</p>
<table>
<thead>
<tr>
<th>Java 类型</th>
<th>JNI 类型</th>
<th>C/C++ 类型</th>
<th>size 位</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>jboolean</td>
<td>unsigned char</td>
<td>8</td>
</tr>
<tr>
<td>byte</td>
<td>jbyte</td>
<td>char</td>
<td>8</td>
</tr>
<tr>
<td>char</td>
<td>jchar</td>
<td>unsingned short</td>
<td>16</td>
</tr>
<tr>
<td>short</td>
<td>jshort</td>
<td>short</td>
<td>16</td>
</tr>
<tr>
<td>int</td>
<td>jint</td>
<td>int</td>
<td>32</td>
</tr>
<tr>
<td>long</td>
<td>jlong</td>
<td>long</td>
<td>64</td>
</tr>
<tr>
<td>float</td>
<td>jfloat</td>
<td>float</td>
<td>32</td>
</tr>
<tr>
<td>double</td>
<td>jdouble</td>
<td>double</td>
<td>64</td>
</tr>
</tbody></table>
<p><strong>1.2 引用类型:</strong></p>
<p>与基本数据类型不同，引用类型对原生方法时不透明的，引用类型映射如下表所示。它们的内部数据结构并不直接向原生代码公开。</p>
<table>
<thead>
<tr>
<th>Java 类型</th>
<th>原生类型</th>
</tr>
</thead>
<tbody><tr>
<td>Java.lang.Class</td>
<td>jclass</td>
</tr>
<tr>
<td>Java.lang.Throwable</td>
<td>jthrowable</td>
</tr>
<tr>
<td>Java.lang.String</td>
<td>jstring</td>
</tr>
<tr>
<td>Other objects</td>
<td>jobjects</td>
</tr>
<tr>
<td>Java.lang.Object[]</td>
<td>jobjectArray</td>
</tr>
<tr>
<td>boolean[]</td>
<td>jbooleanArray</td>
</tr>
<tr>
<td>byte[]</td>
<td>jbyteArray</td>
</tr>
<tr>
<td>char[]</td>
<td>jcharArray</td>
</tr>
<tr>
<td>short[]</td>
<td>jshortArray</td>
</tr>
<tr>
<td>int[]</td>
<td>jintArray</td>
</tr>
<tr>
<td>long[]</td>
<td>jlongArray</td>
</tr>
<tr>
<td>float[]</td>
<td>jfloatArray</td>
</tr>
<tr>
<td>double[]</td>
<td>jdoubleArray</td>
</tr>
<tr>
<td>Other arrays</td>
<td>jarray</td>
</tr>
</tbody></table>
<p><strong>1.3 数据类型描述符</strong></p>
<p>在 JVM 虚拟机中，存储数据类型的名称时，是使用指定的描述符来存储，而不是我们习惯的 int，float 等。</p>
<table>
<thead>
<tr>
<th>Java 类型</th>
<th>签名 (描述符)</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td>J</td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>double</td>
<td>D</td>
</tr>
<tr>
<td>void</td>
<td>V</td>
</tr>
<tr>
<td>其它引用类型</td>
<td>L + 全类名 + ；</td>
</tr>
<tr>
<td>type[]</td>
<td>[</td>
</tr>
<tr>
<td>method type</td>
<td>(参数)返回值</td>
</tr>
</tbody></table>
<p>示例:</p>
<blockquote>
<ul>
<li>表示一个 String</li>
</ul>
<p>Java 类型 :  java.lang.String</p>
<p>JNI 描述符: Ljava/lang/String;  (L + 类全名 + ；)</p>
<ul>
<li>表示一个数组</li>
</ul>
<p>Java 类型: String[]<br>JNI 描述符:  [Ljava/lang/String;<br>Java 类型: int [] []<br>JNI 描述符: [[I</p>
<ul>
<li>表示一个方法</li>
</ul>
<p>Java 方法: long func(int n, String s, int[] arr);<br>JNI 描述符: (ILjava/lang/String;[I)J</p>
<p>Java 方法: void func();<br>JNI 描述符: ()V</p>
</blockquote>
<p>也可以使用命令 : <strong>javap -s 全路径</strong> 来获取方法签名</p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108204504.png" alt=""></p>
<h3 id="2-JNIEnv-和-JavaVm-介绍"><a href="#2-JNIEnv-和-JavaVm-介绍" class="headerlink" title="2. JNIEnv 和 JavaVm 介绍"></a>2. JNIEnv 和 JavaVm 介绍</h3><p><strong>2.1 JNIEnv :</strong></p>
<p>JNIEnv 表示 Java 调用 native 语言的环境，是一个封装了几乎全部 JNI 方法的指针。</p>
<p>JNIEnv 只在创建它的线程生效，不能跨线程传递，不同线程的 JNIEnv 彼此独立。</p>
<p>native 环境中创建的线程，如果需要访问 JNI，必须要调用 AttachCurrentThread 关联，并使用 DetachCurrentThread 解除链接。</p>
<p><strong>2.2 JavaVm :</strong></p>
<p>JavaVM 是虚拟机在 JNI 层的代表，<strong>一个进程只有一个 JavaVM</strong>，所有的线程共用一个 JavaVM。</p>
<p><strong>2.3 代码风格 (C/C++)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C: (*env)-&gt;NewStringUTF(env, “Hellow World!”);</span><br><span class="line"></span><br><span class="line">C++: env-&gt;NewStringUTF(“Hellow World!”);</span><br></pre></td></tr></table></figure>

<h3 id="3-JNI-API"><a href="#3-JNI-API" class="headerlink" title="3. JNI API"></a>3. JNI API</h3><p>参考<a href="https://docs.oracle.com/javase/10/docs/specs/jni/index.html">官方 API 文档</a> 或者 <a href="https://blog.csdn.net/afei__/article/details/81016413">JNI 方法大全及使用示例</a></p>
<h3 id="4-对数据类型的操作"><a href="#4-对数据类型的操作" class="headerlink" title="4. 对数据类型的操作"></a>4. 对数据类型的操作</h3><p><strong>JNI 处理 Java 传递过来的数据</strong></p>
<ol>
<li><p>定义 native 函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 加载 native 库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 1. Java 数据传递给 native */</span></span><br><span class="line">        test1(<span class="keyword">true</span>,</span><br><span class="line">                (<span class="keyword">byte</span>) <span class="number">1</span>,</span><br><span class="line">                <span class="string">','</span>,</span><br><span class="line">                (<span class="keyword">short</span>) <span class="number">3</span>,</span><br><span class="line">                <span class="number">4</span>,</span><br><span class="line">                <span class="number">3.3f</span>,</span><br><span class="line">                <span class="number">2.2</span>d,</span><br><span class="line">                <span class="string">"DevYK"</span>,</span><br><span class="line">                <span class="number">28</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> String[]&#123;<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"4"</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> Person(<span class="string">"阳坤"</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="keyword">boolean</span>[]&#123;<span class="keyword">false</span>, <span class="keyword">true</span>&#125;</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Java 将数据传递到 native 中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> b,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">byte</span> b1,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">char</span> c,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">short</span> s,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> l,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">float</span> f,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">double</span> d,</span></span></span><br><span class="line"><span class="function"><span class="params">            String name,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> age,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[] i,</span></span></span><br><span class="line"><span class="function"><span class="params">            String[] strs,</span></span></span><br><span class="line"><span class="function"><span class="params">            Person person,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span>[] bArray</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>jni 处理 Java 传递过来的数据</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG <span class="meta-string">"native-lib"</span></span></span><br><span class="line"><span class="comment">// __VA_ARGS__ 代表 ...的可变参数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG,  __VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, TAG,  __VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO, TAG,  __VA_ARGS__);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span><span class="comment">//支持 C 语言代码</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL</span><br><span class="line">Java_com_devyk_ndk_1sample_MainActivity_test1(JNIEnv *env, jobject instance,</span><br><span class="line">                                              jboolean jboolean1,</span><br><span class="line">                                              jbyte jbyte1,</span><br><span class="line">                                              jchar jchar1,</span><br><span class="line">                                              jshort jshort1,</span><br><span class="line">                                              jlong jlong1,</span><br><span class="line">                                              jfloat jfloat1,</span><br><span class="line">                                              jdouble jdouble1,</span><br><span class="line">                                              jstring name_,</span><br><span class="line">                                              jint age,</span><br><span class="line">                                              jintArray i_,</span><br><span class="line">                                              jobjectArray strs,</span><br><span class="line">                                              jobject person,</span><br><span class="line">                                              jbooleanArray bArray_</span><br><span class="line">                                             ) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 接收 Java 传递过来的 boolean 值</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> b_boolean = jboolean1;</span><br><span class="line">    LOGD(<span class="string">"boolean-&gt; %d"</span>, b_boolean);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 接收 Java 传递过来的 boolean 值</span></span><br><span class="line">    <span class="keyword">char</span> c_byte = jbyte1;</span><br><span class="line">    LOGD(<span class="string">"jbyte-&gt; %d"</span>, c_byte);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 接收 Java 传递过来的 char 值</span></span><br><span class="line">    <span class="keyword">unsigned</span> short c_char = jchar1;</span><br><span class="line">    LOGD(<span class="string">"char-&gt; %d"</span>, c_char);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 接收 Java 传递过来的 short 值</span></span><br><span class="line">    short s_short = jshort1;</span><br><span class="line">    LOGD(<span class="string">"short-&gt; %d"</span>, s_short);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 接收 Java 传递过来的 long 值</span></span><br><span class="line">    <span class="keyword">long</span> l_long = jlong1;</span><br><span class="line">    LOGD(<span class="string">"long-&gt; %d"</span>, l_long);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. 接收 Java 传递过来的 float 值</span></span><br><span class="line">    <span class="keyword">float</span> f_float = jfloat1;</span><br><span class="line">    LOGD(<span class="string">"float-&gt; %f"</span>, f_float);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7. 接收 Java 传递过来的 double 值</span></span><br><span class="line">    <span class="keyword">double</span> d_double = jdouble1;</span><br><span class="line">    LOGD(<span class="string">"double-&gt; %f"</span>, d_double);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8. 接收 Java 传递过来的 String 值</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name_string = env-&gt;GetStringUTFChars(name_, <span class="number">0</span>);</span><br><span class="line">    LOGD(<span class="string">"string-&gt; %s"</span>, name_string);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//9. 接收 Java 传递过来的 int 值</span></span><br><span class="line">    <span class="keyword">int</span> age_java = age;</span><br><span class="line">    LOGD(<span class="string">"int:%d"</span>, age_java);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//10. 打印 Java 传递过来的 int []</span></span><br><span class="line">    jint *intArray = env-&gt;GetIntArrayElements(i_, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//拿到数组长度</span></span><br><span class="line">    jsize intArraySize = env-&gt;GetArrayLength(i_);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; intArraySize; ++i) &#123;</span><br><span class="line">        LOGD(<span class="string">"intArray-&gt;%d："</span>, intArray[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//释放数组</span></span><br><span class="line">    env-&gt;ReleaseIntArrayElements(i_, intArray, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//11. 打印 Java 传递过来的 String[]</span></span><br><span class="line">    jsize stringArrayLength = env-&gt;GetArrayLength(strs);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; stringArrayLength; ++i) &#123;</span><br><span class="line">        jobject jobject1 = env-&gt;GetObjectArrayElement(strs, i);</span><br><span class="line">        <span class="comment">//强转 JNI String</span></span><br><span class="line">        jstring stringArrayData = <span class="keyword">static_cast</span>&lt;jstring &gt;(jobject1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转 C  String</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *itemStr = env-&gt;GetStringUTFChars(stringArrayData, <span class="literal">NULL</span>);</span><br><span class="line">        LOGD(<span class="string">"String[%d]: %s"</span>, i, itemStr);</span><br><span class="line">        <span class="comment">//回收 String[]</span></span><br><span class="line">        env-&gt;ReleaseStringUTFChars(stringArrayData, itemStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//12. 打印 Java 传递过来的 Object 对象</span></span><br><span class="line">    <span class="comment">//12.1 获取字节码</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *person_class_str = <span class="string">"com/devyk/ndk_sample/Person"</span>;</span><br><span class="line">    <span class="comment">//12.2 转 jni jclass</span></span><br><span class="line">    jclass person_class = env-&gt;FindClass(person_class_str);</span><br><span class="line">    <span class="comment">//12.3 拿到方法签名 javap -a</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sig = <span class="string">"()Ljava/lang/String;"</span>;</span><br><span class="line">    jmethodID jmethodID1 = env-&gt;GetMethodID(person_class, <span class="string">"getName"</span>, sig);</span><br><span class="line"></span><br><span class="line">    jobject obj_string = env-&gt;CallObjectMethod(person, jmethodID1);</span><br><span class="line">    jstring perStr = <span class="keyword">static_cast</span>&lt;jstring &gt;(obj_string);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *itemStr2 = env-&gt;GetStringUTFChars(perStr, <span class="literal">NULL</span>);</span><br><span class="line">    LOGD(<span class="string">"Person: %s"</span>, itemStr2);</span><br><span class="line">    env-&gt;DeleteLocalRef(person_class); <span class="comment">// 回收</span></span><br><span class="line">    env-&gt;DeleteLocalRef(person); <span class="comment">// 回收</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//13. 打印 Java 传递过来的 booleanArray</span></span><br><span class="line">    jsize booArrayLength = env-&gt;GetArrayLength(bArray_);</span><br><span class="line">    jboolean *bArray = env-&gt;GetBooleanArrayElements(bArray_, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; booArrayLength; ++i) &#123;</span><br><span class="line">        <span class="keyword">bool</span> b =  bArray[i];</span><br><span class="line">        jboolean b2 =  bArray[i];</span><br><span class="line">        LOGD(<span class="string">"boolean:%d"</span>,b)</span><br><span class="line">        LOGD(<span class="string">"jboolean:%d"</span>,b2)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//回收</span></span><br><span class="line">    env-&gt;ReleaseBooleanArrayElements(bArray_, bArray, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt; **输出:**</span><br><span class="line">&gt;</span><br><span class="line">&gt; native-lib: boolean-&gt; 1</span><br><span class="line">&gt; native-lib: jbyte-&gt; 1</span><br><span class="line">&gt; native-lib: char-&gt; 44</span><br><span class="line">&gt; native-lib: short-&gt; 3</span><br><span class="line">&gt; native-lib: long-&gt; 4</span><br><span class="line">&gt; native-lib: float-&gt; 3.300000</span><br><span class="line">&gt; native-lib: double-&gt; 2.200000</span><br><span class="line">&gt; native-lib: string-&gt; DevYK</span><br><span class="line">&gt; native-lib: int:28</span><br><span class="line">&gt; native-lib: intArray-&gt;1：</span><br><span class="line">&gt; native-lib: intArray-&gt;2：</span><br><span class="line">&gt; native-lib: intArray-&gt;3：</span><br><span class="line">&gt; native-lib: intArray-&gt;4：</span><br><span class="line">&gt; native-lib: intArray-&gt;5：</span><br><span class="line">&gt; native-lib: intArray-&gt;6：</span><br><span class="line">&gt; native-lib: intArray-&gt;7：</span><br><span class="line">&gt; native-lib: String[0]: 1</span><br><span class="line">&gt; native-lib: String[1]: 2</span><br><span class="line">&gt; native-lib: String[2]: 4</span><br><span class="line">&gt; native-lib: Person: 阳坤</span><br><span class="line">&gt; native-lib: boolean:0</span><br><span class="line">&gt; native-lib: jboolean:0</span><br><span class="line">&gt; native-lib: boolean:1</span><br><span class="line">&gt; native-lib: jboolean:1</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>​        </p>
<p><strong>JNI 处理 Java 对象</strong></p>
<ol>
<li><p>定义一个 Java 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Person&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义 native 接口</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="title">extends</span> <span class="title">AppCompatActivity</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> TAG = <span class="keyword">this</span>.getClass().getSimpleName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 加载 native 库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        TextView <span class="built_in">text</span> = findViewById(R.id.sample_text);</span><br><span class="line">        <span class="comment">/**处理 Java 对象*/</span></span><br><span class="line">        <span class="keyword">String</span> str = getPerson().toString();</span><br><span class="line">        <span class="built_in">text</span>.setText(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> native Person <span class="title">getPerson</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据上面代码我们知道，如果获取成功，手机屏幕上肯定会打印会显示数据。</p>
</li>
<li><p>JNI 的处理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT jobject JNICALL</span><br><span class="line">Java_com_devyk_ndk_1sample_MainActivity_getPerson(JNIEnv *env, jobject instance) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 拿到 Java 类的全路径</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *person_java = <span class="string">"com.devyk.ndk_sample.Person"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *method = <span class="string">"&lt;init&gt;"</span>; <span class="comment">// Java构造方法的标识</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2. 找到需要处理的 Java 对象 class</span></span><br><span class="line">    jclass j_person_class = env-&gt;FindClass(person_java);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3. 拿到空参构造方法</span></span><br><span class="line">    jmethodID person_constructor = env-&gt;GetMethodID(j_person_class, method, <span class="string">"()V"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4. 创建对象</span></span><br><span class="line">    jobject person_obj = env-&gt;NewObject(j_person_class, person_constructor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 拿到 setName 方法的签名，并拿到对应的 setName 方法</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *nameSig = <span class="string">"(Ljava/lang/String;)V"</span>;</span><br><span class="line">    jmethodID nameMethodId = env-&gt;GetMethodID(j_person_class, <span class="string">"setName"</span>, nameSig);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//6. 拿到 setAge 方法的签名，并拿到 setAge 方法</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ageSig = <span class="string">"(I)V"</span>;</span><br><span class="line">    jmethodID ageMethodId = env-&gt;GetMethodID(j_person_class, <span class="string">"setAge"</span>, ageSig);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7. 正在调用 Java 对象函数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name = <span class="string">"DevYK"</span>;</span><br><span class="line">    jstring newStringName = env-&gt;NewStringUTF(name);</span><br><span class="line">    env-&gt;CallVoidMethod(person_obj, nameMethodId, newStringName);</span><br><span class="line">    env-&gt;CallVoidMethod(person_obj, ageMethodId, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sig = <span class="string">"()Ljava/lang/String;"</span>;</span><br><span class="line">    jmethodID jtoString = env-&gt;GetMethodID(j_person_class, <span class="string">"toString"</span>, sig);</span><br><span class="line">    jobject obj_string = env-&gt;CallObjectMethod(person_obj, jtoString);</span><br><span class="line">    jstring perStr = <span class="keyword">static_cast</span>&lt;jstring &gt;(obj_string);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *itemStr2 = env-&gt;GetStringUTFChars(perStr, <span class="literal">NULL</span>);</span><br><span class="line">    LOGD(<span class="string">"Person: %s"</span>, itemStr2);</span><br><span class="line">    <span class="keyword">return</span> person_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108154952.gif" alt=""></p>
<p>可以看到 native 返回数据给 Java 了。</p>
</li>
</ol>
<h3 id="5-JNI-动态注册"><a href="#5-JNI-动态注册" class="headerlink" title="5. JNI 动态注册"></a>5. JNI 动态注册</h3><p>前面咱们学习的都是静态注册，静态注册虽然简单方便，但是也面临一个较大的问题，如果当前类定义的 native 方法名称改变或者包名改变，那么这一改也就面临在 cpp 中实现的也将改动，如果将要面临这种情况你可以试试 JNI 动态注册，如下代码所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String TAG = <span class="keyword">this</span>.getClass().getSimpleName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 加载 native 库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        TextView text = findViewById(R.id.sample_text);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**动态注册的 native */</span></span><br><span class="line">        dynamicRegister(<span class="string">"我是动态注册的"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态注册</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">dynamicRegister</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cpp：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG <span class="meta-string">"native-lib"</span></span></span><br><span class="line"><span class="comment">// __VA_ARGS__ 代表 ...的可变参数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG,  __VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, TAG,  __VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO, TAG,  __VA_ARGS__);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 动态注册</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对应java类的全路径名，.用/代替</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *classPathName = <span class="string">"com/devyk/ndk_sample/MainActivity"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_dynamicRegister(JNIEnv *env, jobject instance, jstring name) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *j_name = env-&gt;GetStringUTFChars(name, <span class="literal">NULL</span>);</span><br><span class="line">    LOGD(<span class="string">"动态注册: %s"</span>, j_name)</span><br><span class="line">    <span class="comment">//释放</span></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(name, j_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 源码结构体</span></span><br><span class="line"><span class="comment"> * typedef struct &#123;</span></span><br><span class="line"><span class="comment">    const char* name;</span></span><br><span class="line"><span class="comment">    const char* signature;</span></span><br><span class="line"><span class="comment">    void*       fnPtr;</span></span><br><span class="line"><span class="comment">    &#125; JNINativeMethod;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod jniNativeMethod[] = &#123;</span><br><span class="line">        &#123;<span class="string">"dynamicRegister"</span>, <span class="string">"(Ljava/lang/String;)V"</span>, (<span class="keyword">void</span> *) (native_dynamicRegister)&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 该函数定义在jni.h头文件中，System.loadLibrary()时会调用JNI_OnLoad()函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">JNI_OnLoad(JavaVM *javaVm, <span class="keyword">void</span> *pVoid) &#123;</span><br><span class="line">    <span class="comment">//通过虚拟机 创建爱你全新的 evn</span></span><br><span class="line">    JNIEnv *jniEnv = <span class="literal">nullptr</span>;</span><br><span class="line">    jint result = javaVm-&gt;GetEnv(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> **&gt;(&amp;jniEnv), JNI_VERSION_1_6);</span><br><span class="line">    <span class="keyword">if</span> (result != JNI_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_ERR; <span class="comment">// 主动报错</span></span><br><span class="line">    &#125;</span><br><span class="line">    jclass mainActivityClass = jniEnv-&gt;FindClass(classPathName);</span><br><span class="line">    jniEnv-&gt;RegisterNatives(mainActivityClass, jniNativeMethod,</span><br><span class="line">                            <span class="keyword">sizeof</span>(jniNativeMethod) / <span class="keyword">sizeof</span>(JNINativeMethod));<span class="comment">//动态注册的数量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>输出:</strong></p>
<p>动态注册: 我是动态注册的</p>
</blockquote>
<h3 id="6-异常处理"><a href="#6-异常处理" class="headerlink" title="6. 异常处理"></a>6. 异常处理</h3><p>异常处理是 Java 程序设计语言的重要功能， JNI 中的异常行为与 Java 中的有所不同，在 Java 中，当抛出一个异常时，虚拟机停止执行代码块并进入调用栈反向检查能处理特定类型异常的异常处理程序代码块，这也叫捕获异常。虚拟机清除异常并将控制权交给异常处理程序。相比之下， JNI 要求开发人员在异常发生后显式地实现异常处理流。</p>
<p><strong>捕获异常:</strong></p>
<p>JNIEvn 接口提供了一组与异常相关的函数集，在运行过程中可以使用 Java 类查看这些函数，比如代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">dynamicRegister2</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试抛出异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testException</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"MainActivity testException NullPointerException"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用 testException 方法时，dynamicRegister2 该原生方法需要显式的处理异常信息，JNI 提供了 ExceptionOccurred 函数查询虚拟机中是否有挂起的异常。在使用完之后，异常处理程序需要用 ExceptionClear 函数显式的清除异常，如下代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jthrowable exc = env-&gt;ExceptionOccurred(); <span class="comment">// 检测是否发生异常</span></span><br><span class="line">   <span class="keyword">if</span> (exc) &#123;<span class="comment">//如果发生异常</span></span><br><span class="line">       env-&gt;ExceptionDescribe(); <span class="comment">// 打印异常信息</span></span><br><span class="line">       env-&gt;ExceptionClear(); <span class="comment">// 清除掉发生的异常</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>抛出异常:</strong></p>
<p>JNI 也允许原生代码抛出异常。因为异常是 Java 类，应该先用 FindClass 函数找到异常类，用 ThrowNew 函数可以使用化且抛出新的异常，如下代码所示:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jthrowable exc = env-&gt;ExceptionOccurred(); <span class="comment">// 检测是否发生异常</span></span><br><span class="line">   <span class="keyword">if</span> (exc) &#123;<span class="comment">//如果发生异常</span></span><br><span class="line">       jclass newExcCls = env-&gt;FindClass(<span class="string">"java/lang/IllegalArgumentException"</span>);</span><br><span class="line">       env-&gt;ThrowNew(newExcCls, <span class="string">"JNI 中发生了一个异常信息"</span>); <span class="comment">// 返回一个新的异常到 Java</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>因为原生函数的代码执行不受虚拟机的控制，因此抛出异常并不会停止原生函数的执行并把控制权交给异常处理程序。到抛出异常时，原生函数应该释放所有已分配的原生资源，例如内存及合适的返回值等。通过 JNIEvn 接口获得的引用是局部引用且一旦返回原生函数，它们自动地被虚拟机释放。</p>
<p><strong>示例代码:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String TAG = <span class="keyword">this</span>.getClass().getSimpleName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 加载 native 库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        </span><br><span class="line">        dynamicRegister2(<span class="string">"测试异常处理"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">dynamicRegister2</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试抛出异常</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testException</span><span class="params">()</span> <span class="keyword">throws</span> NullPointerException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"MainActivity testException NullPointerException"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>native-lib.cpp 文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG <span class="meta-string">"native-lib"</span></span></span><br><span class="line"><span class="comment">// __VA_ARGS__ 代表 ...的可变参数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG,  __VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR, TAG,  __VA_ARGS__);</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO, TAG,  __VA_ARGS__);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 动态注册</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_dynamicRegister2(JNIEnv *env, jobject instance, jstring name) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *j_name = env-&gt;GetStringUTFChars(name, <span class="literal">NULL</span>);</span><br><span class="line">    LOGD(<span class="string">"动态注册: %s"</span>, j_name)</span><br><span class="line"></span><br><span class="line">    jclass clazz = env-&gt;GetObjectClass(instance);<span class="comment">//拿到当前类的class</span></span><br><span class="line">    jmethodID mid =env-&gt;GetMethodID(clazz, <span class="string">"testException"</span>, <span class="string">"()V"</span>);<span class="comment">//执行 Java 测试抛出异常的代码</span></span><br><span class="line">    env-&gt;CallVoidMethod(instance, mid); <span class="comment">// 执行会抛出一个异常</span></span><br><span class="line">    jthrowable exc = env-&gt;ExceptionOccurred(); <span class="comment">// 检测是否发生异常</span></span><br><span class="line">    <span class="keyword">if</span> (exc) &#123;<span class="comment">//如果发生异常</span></span><br><span class="line">        env-&gt;ExceptionDescribe(); <span class="comment">// 打印异常信息</span></span><br><span class="line">        env-&gt;ExceptionClear(); <span class="comment">// 清除掉发生的异常</span></span><br><span class="line">        jclass newExcCls = env-&gt;FindClass(<span class="string">"java/lang/IllegalArgumentException"</span>);</span><br><span class="line">        env-&gt;ThrowNew(newExcCls, <span class="string">"JNI 中发生了一个异常信息"</span>); <span class="comment">// 返回一个新的异常到 Java</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//释放</span></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(name, j_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这里还是使用的动态注册。</p>
<p>最后效果如下:</p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108222721.png" alt=""></p>
<p>可以看见这里即捕获到了 Java 抛出的异常，也抛出了一个 JNI 新的异常信息。</p>
<h3 id="7-局部与全局引用"><a href="#7-局部与全局引用" class="headerlink" title="7. 局部与全局引用"></a>7. 局部与全局引用</h3><p>引用在 Java 程序设计中扮演非常重要的角色。虚拟机通过追踪类实例的引用并收回不在引用的垃圾来管理类实例的使用期限。因为原生代码不是一个管理环境，因此 JNI 提供了一组函数允许原生代码显式地管理对象引用及使用期间原生代码。 JNI 支持三种引用: 局部引用、全局引用和弱全局引用。下面将介绍这几类引用。</p>
<p><strong>局部引用:</strong></p>
<p>大多数 JNI 函数返回局部引用。局部应用不能在后续的调用中被缓存及重用，主要是因为它们的使用期限仅限于原生方法，一旦原生方法返回，局部引用即被释放。例如: FindClass 函数返回一个局部引用，当原生方法返回时，它被自动释放，也可以用 DeleteLocalRef 函数显式的释放原生代码。如下代码所示:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">jclass personClass;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_test4(JNIEnv *env, jobject instance) &#123;</span><br><span class="line">    LOGD(<span class="string">"测试局部引用"</span>)</span><br><span class="line">    <span class="keyword">if</span> (personClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *person_class = <span class="string">"com/devyk/ndk_sample/Person"</span>;</span><br><span class="line">        personClass = env-&gt;FindClass(person_class);</span><br><span class="line">        LOGD(<span class="string">"personClass == null 执行了。"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Java Person 构造方法实例化</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sig = <span class="string">"()V"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *method = <span class="string">"&lt;init&gt;"</span>;<span class="comment">//Java 构造方法标识</span></span><br><span class="line">    jmethodID init = env-&gt;GetMethodID(personClass, method, sig);</span><br><span class="line">    <span class="comment">//创建出来</span></span><br><span class="line">    env-&gt;NewObject(personClass, init);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果:</p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108231036.gif" alt=""></p>
<p>跟介绍的一样的吧。局部引用不能再后续的调用中重复使用，那么怎么解决这个问题勒，其实只要把局部引用提升为全局引用或者调用 DeleteLocalRef 显式释放就行了。这个我们在全局引用中演示。</p>
<p><strong>全局引用:</strong></p>
<p>全局引用在原生方法的后续调用过程中依然有效，除非它们被原生代码显式释放。</p>
<ol>
<li><p>创建全局引用</p>
<p>可以使用 NewGlobalRef 函数将局部引用初始化为全局引用，如下代码所示:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">jclass personClass;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_test4(JNIEnv *env, jobject instance) &#123;</span><br><span class="line">    LOGD(<span class="string">"测试局部引用"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (personClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//1. 提升全局解决不能重复使用问题</span></span><br><span class="line"> 				<span class="keyword">const</span> <span class="keyword">char</span> *person_class = <span class="string">"com/devyk/ndk_sample/Person"</span>;</span><br><span class="line">        jclass jclass1 = env-&gt;FindClass(person_class);</span><br><span class="line">        personClass = <span class="keyword">static_cast</span>&lt;jclass&gt;(env-&gt;NewGlobalRef(jclass1));</span><br><span class="line">        LOGD(<span class="string">"personClass == null 执行了。"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Java Person 构造方法实例化</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sig = <span class="string">"()V"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *method = <span class="string">"&lt;init&gt;"</span>;<span class="comment">//Java 构造方法标识</span></span><br><span class="line">    jmethodID init = env-&gt;GetMethodID(personClass, method, sig);</span><br><span class="line">    <span class="comment">//创建出来</span></span><br><span class="line">    env-&gt;NewObject(personClass, init);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 显式释放主动删除全局引用</span></span><br><span class="line">    env-&gt;DeleteLocalRef(personClass);</span><br><span class="line">    personClass = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200108232508.gif" alt=""></p>
</li>
<li><p>删除全局引用</p>
<p>当原生代码不再需要一个全局引用时，可以随时用 DeleteGlobalRef 函数释放它，如下代码所示:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;DeleteLocalRef(personClass);</span><br><span class="line">personClass = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>弱全局引用</strong></p>
<p>全局引用的另一种类型是弱全局引用。与全局引用一样，弱全局引用在原生方法的后续调用依然有效。与全局引用不同，弱全局引用并不阻止潜在的对象被垃圾收回。</p>
<ol>
<li><p>创建弱全局引用</p>
<p>可以使用 NewWeakGlobalRef 函数对弱全局引用进行初始化，如下所示:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">jclass personClass;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_test4(JNIEnv *env, jobject instance) &#123;</span><br><span class="line">    LOGD(<span class="string">"测试局部引用"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (personClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//1. 提升全局解决不能重复使用问题</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *person_class = <span class="string">"com/devyk/ndk_sample/Person"</span>;</span><br><span class="line">        jclass jclass1 = env-&gt;FindClass(person_class);</span><br><span class="line"><span class="comment">//        personClass = static_cast&lt;jclass&gt;(env-&gt;NewGlobalRef(jclass1));</span></span><br><span class="line">        personClass = <span class="keyword">static_cast</span>&lt;jclass&gt;(env-&gt;NewWeakGlobalRef(jclass1));</span><br><span class="line">        LOGD(<span class="string">"personClass == null 执行了。"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Java Person 构造方法实例化</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *sig = <span class="string">"()V"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *method = <span class="string">"&lt;init&gt;"</span>;<span class="comment">//Java 构造方法标识</span></span><br><span class="line">    jmethodID init = env-&gt;GetMethodID(personClass, method, sig);</span><br><span class="line">    <span class="comment">//创建出来</span></span><br><span class="line">    env-&gt;NewObject(personClass, init);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 显式释放主动删除局部引用</span></span><br><span class="line"><span class="comment">//    env-&gt;DeleteLocalRef(personClass);</span></span><br><span class="line">    env-&gt;DeleteWeakGlobalRef(personClass);</span><br><span class="line">    personClass = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>弱全局引用的有效性检验</p>
<p>可以用 IsSameObject 函数来检验一个弱全局引用是否仍然指向活动的类实例.</p>
</li>
<li><p>删除弱全局引用</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;DeleteWeakGlobalRef(personClass);</span><br></pre></td></tr></table></figure>

<p>全局引用显示释放前一直有效，它们可以被其它原生函数及原生线程使用。</p>
</li>
</ol>
<h3 id="8-JNI-线程操作"><a href="#8-JNI-线程操作" class="headerlink" title="8. JNI 线程操作"></a>8. JNI 线程操作</h3><p>作为多线程环境的一部分，虚拟机支持运行的原生代码。在开发构件时要记住 JNI 技术的一些约束:</p>
<ul>
<li>只有再原生方法执行期间及正在执行原生方法的线程环境下局部引用是有效的，局部引用不能再多线程间共享，只有全局可以被多个线程共享。</li>
<li>被传递给每个原生方法的 JNIEvn 接口指针在与方法调用相关的线程中也是有效的，它不能被其它线程缓存或使用。</li>
</ul>
<p><strong>同步:</strong></p>
<p>同步是多线程程序设计最终的特征。与 Java 同步类似， JNI 的监视器允许原生代码利用 Java 对象同步，虚拟机保证存取监视器的线程能够安全执行，而其他线程等待监视器对象变成可用状态。 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">MonitorEnter</span><span class="params">(jobject obj)</span></span></span><br></pre></td></tr></table></figure>

<p>对 MonitorEnter 函数的调用应该与对 MonitorExit 的调用相匹配，从而避免代码出现死锁。</p>
<p>例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                count();</span><br><span class="line">                nativeCount();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        count++;</span><br><span class="line">        Log.d(<span class="string">"Java"</span>, <span class="string">"count="</span> + count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">nativeCount</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>native 代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_count(JNIEnv *env, jobject instance) &#123;</span><br><span class="line"></span><br><span class="line">    jclass cls = env-&gt;GetObjectClass(instance);</span><br><span class="line">    jfieldID fieldID = env-&gt;GetFieldID(cls, <span class="string">"count"</span>, <span class="string">"I"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*if (env-&gt;MonitorEnter(instance) != JNI_OK) &#123;</span></span><br><span class="line"><span class="comment">        LOGE("%s: MonitorEnter() failed", __FUNCTION__);</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* synchronized block */</span></span><br><span class="line">    <span class="keyword">int</span> val = env-&gt;GetIntField(instance, fieldID);</span><br><span class="line">    val++;</span><br><span class="line">    LOGI(<span class="string">"count=%d"</span>, val);</span><br><span class="line">    env-&gt;SetIntField(instance, fieldID, val);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*if (env-&gt;ExceptionOccurred()) &#123;</span></span><br><span class="line"><span class="comment">        LOGE("ExceptionOccurred()...");</span></span><br><span class="line"><span class="comment">        if (env-&gt;MonitorExit(instance) != JNI_OK) &#123;</span></span><br><span class="line"><span class="comment">            LOGE("%s: MonitorExit() failed", __FUNCTION__);</span></span><br><span class="line"><span class="comment">        &#125;;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    if (env-&gt;MonitorExit(instance) != JNI_OK) &#123;</span></span><br><span class="line"><span class="comment">        LOGE("%s: MonitorExit() failed", __FUNCTION__);</span></span><br><span class="line"><span class="comment">    &#125;;*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 native 中没有进行同步，打印如下:</p>
<blockquote>
<p><strong>输出:</strong></p>
<p>2020-01-09 00:02:29.637 17573-17707/com.devyk.ndk_sample D/Java:         count=1<br>2020-01-09 00:02:29.637 17573-17707/com.devyk.ndk_sample I/native-lib:  count=2<br>2020-01-09 00:02:29.641 17573-17708/com.devyk.ndk_sample D/Java:         count=3<br>2020-01-09 00:02:29.641 17573-17708/com.devyk.ndk_sample I/native-lib:  count=4<br>2020-01-09 00:02:29.641 17573-17709/com.devyk.ndk_sample D/Java:         count=5<br>2020-01-09 00:02:29.641 17573-17709/com.devyk.ndk_sample I/native-lib: count=6<br>2020-01-09 00:02:29.641 17573-17710/com.devyk.ndk_sample D/Java:         count=7<br>2020-01-09 00:02:29.642 17573-17710/com.devyk.ndk_sample I/native-lib: count=8<br>2020-01-09 00:02:29.643 17573-17711/com.devyk.ndk_sample D/Java:         count=9<br>2020-01-09 00:02:29.643 17573-17711/com.devyk.ndk_sample I/native-lib: count=10<br>2020-01-09 00:02:29.643 17573-17712/com.devyk.ndk_sample D/Java:         count=11<br>2020-01-09 00:02:29.643 17573-17712/com.devyk.ndk_sample I/native-lib: count=12<br>2020-01-09 00:02:29.645 17573-17715/com.devyk.ndk_sample D/Java:         count=13<br>2020-01-09 00:02:29.646 17573-17715/com.devyk.ndk_sample I/native-lib: count=15<br>2020-01-09 00:02:29.646 17573-17714/com.devyk.ndk_sample D/Java:         count=15<br>2020-01-09 00:02:29.646 17573-17714/com.devyk.ndk_sample I/native-lib: count=16<br>2020-01-09 00:02:29.648 17573-17713/com.devyk.ndk_sample D/Java:        count=17<br>2020-01-09 00:02:29.648 17573-17713/com.devyk.ndk_sample I/native-lib: count=18<br>2020-01-09 00:02:29.648 17573-17716/com.devyk.ndk_sample D/Java:         count=19<br>2020-01-09 00:02:29.648 17573-17716/com.devyk.ndk_sample I/native-lib: count=20</p>
</blockquote>
<p>通过多线程对 count 字段操作，可以看见已经无法保证 count 的可见性了。这就需要 JNI 本地实现也要同步。</p>
<p>我们把注释放开:</p>
<p>打印如下:</p>
<blockquote>
<p><strong>输出:</strong></p>
<p>2020-01-09 00:07:10.579 18225-18385/com.devyk.ndk_sample D/Java:             count=1<br>2020-01-09 00:07:10.579 18225-18385/com.devyk.ndk_sample I/native-lib:     count=2<br>2020-01-09 00:07:10.581 18225-18386/com.devyk.ndk_sample D/Java:             count=3<br>2020-01-09 00:07:10.581 18225-18386/com.devyk.ndk_sample I/native-lib:     count=4<br>2020-01-09 00:07:10.582 18225-18387/com.devyk.ndk_sample D/Java:             count=5<br>2020-01-09 00:07:10.582 18225-18387/com.devyk.ndk_sample I/native-lib:     count=6<br>2020-01-09 00:07:10.584 18225-18388/com.devyk.ndk_sample D/Java:             count=7<br>2020-01-09 00:07:10.584 18225-18388/com.devyk.ndk_sample I/native-lib:     count=8<br>2020-01-09 00:07:10.586 18225-18390/com.devyk.ndk_sample D/Java:             count=9<br>2020-01-09 00:07:10.586 18225-18390/com.devyk.ndk_sample I/native-lib:     count=10<br>2020-01-09 00:07:10.586 18225-18391/com.devyk.ndk_sample D/Java:             count=11<br>2020-01-09 00:07:10.586 18225-18391/com.devyk.ndk_sample I/native-lib:     count=12<br>2020-01-09 00:07:10.586 18225-18393/com.devyk.ndk_sample D/Java:             count=13<br>2020-01-09 00:07:10.587 18225-18389/com.devyk.ndk_sample D/Java:             count=14<br>2020-01-09 00:07:10.587 18225-18389/com.devyk.ndk_sample I/native-lib:     count=15<br>2020-01-09 00:07:10.587 18225-18393/com.devyk.ndk_sample I/native-lib:     count=16<br>2020-01-09 00:07:10.587 18225-18394/com.devyk.ndk_sample D/Java:             count=17<br>2020-01-09 00:07:10.588 18225-18394/com.devyk.ndk_sample I/native-lib:     count=18<br>2020-01-09 00:07:10.588 18225-18392/com.devyk.ndk_sample D/Java:             count=19<br>2020-01-09 00:07:10.588 18225-18392/com.devyk.ndk_sample I/native-lib:     count=20</p>
</blockquote>
<p>现在保证了count 的可见性了。</p>
<p><strong>原生线程:</strong></p>
<p>为了执行特定任务，这些原生构建可以并行使用原生线程。因为虚拟机不知道原生线程，因此它们不能与 Java 构建直接通信。为了与应用的依然活跃部分交互，原生线程应该先附着在虚拟机上。</p>
<p>JNI 通过 JavaVM 接口指针提供了 AttachCurrentThread 函数以便于让原生代码将原生线程附着到虚拟机上，如下代码所示, JavaVM 接口指针应该尽早被缓存，否则的话它不能被获取。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JavaVM* jvm；</span><br><span class="line">...</span><br><span class="line">JNIEnv* env = <span class="literal">NULL</span>；</span><br><span class="line">...</span><br><span class="line">jvm-&gt;AttachCurrentThread(&amp;env,<span class="number">0</span>);<span class="comment">//把 native 线程附着到 JVM 上</span></span><br><span class="line">...</span><br><span class="line">jvm-&gt;DetachCurrentThread();<span class="comment">//解除 附着 到 JVM 的 native 线程</span></span><br></pre></td></tr></table></figure>

<p>对 AttachCurrentThread 函数的调用允许应用程序获得对当前线程有效的 JNIEnv 接口指针。将一个已经附着的原生线程再次附着不会有任何副作用。当原生线程完成时，可以用 DetachCurrentThread 函数将原生线程与虚拟机分离。</p>
<p>例子:</p>
<p>MainActivity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    testThread();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AndroidUI操作，让C++线程里面来调用</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Looper.getMainLooper() == Looper.myLooper()) &#123;</span><br><span class="line">        <span class="keyword">new</span> AlertDialog.Builder(MainActivity.<span class="keyword">this</span>)</span><br><span class="line">                .setTitle(<span class="string">"UI"</span>)</span><br><span class="line">                .setMessage(<span class="string">"native 运行在主线程，直接更新 UI ..."</span>)</span><br><span class="line">                .setPositiveButton(<span class="string">"确认"</span>, <span class="keyword">null</span>)</span><br><span class="line">                .show();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">new</span> AlertDialog.Builder(MainActivity.<span class="keyword">this</span>)</span><br><span class="line">                        .setTitle(<span class="string">"UI"</span>)</span><br><span class="line">                        .setMessage(<span class="string">"native运行在子线程切换为主线程更新 UI ..."</span>)</span><br><span class="line">                        .setPositiveButton(<span class="string">"确认"</span>, <span class="keyword">null</span>)</span><br><span class="line">                        .show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">testThread</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">unThread</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDestroy();</span><br><span class="line">    unThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>native-lib.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">JavaVM * jvm;</span><br><span class="line">jobject instance;</span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">customThread</span><span class="params">(<span class="keyword">void</span> * pVoid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用的话，一定需要JNIEnv *env</span></span><br><span class="line">    <span class="comment">// JNIEnv *env 无法跨越线程，只有JavaVM才能跨越线程</span></span><br><span class="line"></span><br><span class="line">    JNIEnv * env = <span class="literal">NULL</span>; <span class="comment">// 全新的env</span></span><br><span class="line">    <span class="keyword">int</span> result = jvm-&gt;AttachCurrentThread(&amp;env, <span class="number">0</span>); <span class="comment">// 把native的线程，附加到JVM</span></span><br><span class="line">    <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jclass mainActivityClass = env-&gt;GetObjectClass(instance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到MainActivity的updateUI</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * sig = <span class="string">"()V"</span>;</span><br><span class="line">    jmethodID updateUI = env-&gt;GetMethodID(mainActivityClass, <span class="string">"updateUI"</span>, sig);</span><br><span class="line"></span><br><span class="line">    env-&gt;CallVoidMethod(instance, updateUI);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解除 附加 到 JVM 的native线程</span></span><br><span class="line">    jvm-&gt;DetachCurrentThread();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_testThread(JNIEnv *env, jobject thiz) &#123;</span><br><span class="line">    instance = env-&gt;NewGlobalRef(thiz); <span class="comment">// 全局的，就不会被释放，所以可以在线程里面用</span></span><br><span class="line">    <span class="comment">// 如果是非全局的，函数一结束，就被释放了</span></span><br><span class="line">    <span class="keyword">pthread_t</span> pthreadID;</span><br><span class="line">    pthread_create(&amp;pthreadID, <span class="number">0</span>, customThread, instance);</span><br><span class="line">    pthread_join(pthreadID, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span>  <span class="comment">//支持 C 语言</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="comment">//告诉虚拟机，这是jni函数</span></span><br><span class="line">native_unThread(JNIEnv *env, jobject thiz) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != instance) &#123;</span><br><span class="line">        env-&gt;DeleteGlobalRef(instance);</span><br><span class="line">        instance = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果:</p>
<p><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200109003303.gif" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>该篇文件全面介绍了 JNI 技术实现 Java 应用程序与原生代码之间通信的方式，关于更多 JNI 技术可以下载  <a href="https://pan.baidu.com/s/1HudsXKOghlmHEcMMlp1W6g">JNI 使用手册</a> 。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/">音视频学习路线</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200604150710.jpeg" alt="支付宝"></span></a><a class="button donate" href="/" style="background-color:rgba(255,128,62,.87);border-color:transparent;color:white;" target="_blank" rel="noopener"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>送我杯咖啡</span></a><a class="button is-danger donate" href="/" target="_blank" rel="noopener"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200604150835.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/06/04/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0-%E5%9B%9B-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%85%A5%E9%97%A8/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">音视频学习 (四) 交叉编译入门</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/06/04/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0-%E4%BA%8C-C-%E8%AF%AD%E8%A8%80%E5%85%A5%E9%97%A8/"><span class="level-item">音视频学习 (二) C++ 语言入门</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "j16d0HiTJvVWRQzjQN625f4W-gzGzoHsz",
            appKey: "7cgla0UfvddS9PjRz7Lcvqn7",
            placeholder: "请遵守中华人民共和国法律法规。填写邮箱信息以接收回复。",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://devyk.oss-cn-qingdao.aliyuncs.com/blog/20200427113132.jpeg" alt="DevYK"></figure><p class="title is-size-4 is-block line-height-inherit">DevYK</p><p class="is-size-6 is-block">Android/NDK/音视频/跨平台</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">27</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">3</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/yangkun19921001" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/yangkun19921001"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="QQ" href="http://wpa.qq.com/msgrd?v=1&amp;uin=919079498&amp;site=ioshenmue&amp;menu=yes"><i class="fab fa-qq"></i></a></div></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://github.com/yangkun19921001/Blog/blob/master/about.md" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">联系我</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://juejin.im/user/578259398ac2470061f3a3fb/posts" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">掘金</span></span><span class="level-right"><span class="level-item tag">juejin.im</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/%E4%B8%93%E9%A2%98/"><span class="level-start"><span class="level-item">专题</span></span><span class="level-end"><span class="level-item tag">25</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><span class="level-start"><span class="level-item">性能优化</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E4%B8%93%E9%A2%98/%E9%9F%B3%E8%A7%86%E9%A2%91/"><span class="level-start"><span class="level-item">音视频</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%9C%8D%E5%8A%A1/"><span class="level-start"><span class="level-item">服务</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/%E6%9C%8D%E5%8A%A1/apprtc/"><span class="level-start"><span class="level-item">apprtc</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%9C%8D%E5%8A%A1/nginx/"><span class="level-start"><span class="level-item">nginx</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/webrtc/"><span class="tag">webrtc</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"><span class="tag">性能优化</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/"><span class="tag">音视频学习路线</span><span class="tag is-grey-lightest">12</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:33:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E5%BF%85%E7%9C%8B%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/">必看的性能优化总结</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:31:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81%E4%B8%89-%E7%A8%B3%E5%AE%9A%E8%BF%90%E8%A1%8C%E4%BC%98%E5%8C%96%E4%B9%8B%E6%8D%95%E8%8E%B7-Native-Crash/">性能优化 (十三) 稳定运行优化之捕获 Native Crash </a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:30:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81%E4%BA%8C-%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96%E4%B9%8B%E6%9E%81%E9%99%90%E7%98%A6%E8%BA%AB/">性能优化 (十二) 体积优化之极限瘦身</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:29:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81%E4%B8%80-%E7%A8%B3%E5%AE%9A%E8%BF%90%E8%A1%8C%E4%BC%98%E5%8C%96%E4%B9%8B%E7%83%AD%E4%BF%AE%E5%A4%8D%E5%8E%9F%E7%90%86%E6%8E%A2%E7%B4%A2/">性能优化 (十一) 稳定运行优化之热修复原理探索</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-06-04T16:27:00.000Z">2020-06-05</time></p><p class="title is-6"><a class="link-muted" href="/2020/06/05/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E5%8D%81-%E6%8C%81%E7%BB%AD%E8%BF%90%E8%A1%8C%E4%BC%98%E5%8C%96%E4%B9%8B%E8%BF%9B%E7%A8%8B%E4%BF%9D%E6%B4%BB%E5%AE%9E%E7%8E%B0/">性能优化 (十) 稳定运行优化之进程保活实现 </a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/">专题</a> / <a class="link-muted" href="/categories/%E4%B8%93%E9%A2%98/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="DevYK 个人博客" height="28"></a><p class="size-small"><span>&copy; 2020 DevYK</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://yoursite.com',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>